#cloud-config

write_files:
  - path: /etc/environment
    append: true
    content: |
      AZURE_SQL_CONN="${azure_sql_conn}"
      AZURE_AI_ENDPOINT="${azure_ai_endpoint}"
      AZURE_AI_KEY="${azure_ai_key}"
      AZURE_STORAGE_CONNECTION_STRING="${storage_conn_string}"
      STORAGE_ACCOUNT_NAME="${storage_account_name}"

  - path: /etc/systemd/system/flaskapp.service
    content: |
      [Unit]
      Description=Gunicorn instance to serve Flask App
      After=network.target

      [Service]
      User=${vm_user}
      Group=${vm_user}
      WorkingDirectory=/app
      EnvironmentFile=/etc/environment
      ExecStart=/app/venv/bin/gunicorn --bind=0.0.0.0:8000 --timeout 600 --workers 4 app:app
      Restart=always

      [Install]
      WantedBy=multi-user.target

package_update: true
packages:
  - python3-pip
  - python3-venv
  - python3-dev
  - unixodbc-dev
  - gnupg2
  - curl
  - unzip

runcmd:
  # ODBC Driver 18
  - curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
  - curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list > /etc/apt/sources.list.d/mssql-release.list
  - apt-get update
  - ACCEPT_EULA=Y apt-get install -y msodbcsql18

  # App setup
  - mkdir -p /app
  - cd /app

  # Wait for backend ZIP and download
  - |
    echo "Waiting for backend ZIP to be available..."
    until curl -sf "${backend_blob_url}" -o /tmp/backend.zip; do
      echo "Backend ZIP not available yet, retrying in 10 seconds..."
      sleep 10
    done

  - unzip /tmp/backend.zip -d /app
  - rm /tmp/backend.zip

  # Fix ownership after unzip
  - chown -R ${vm_user}:${vm_user} /app

  # Python setup
  - python3 -m venv /app/venv
  - /app/venv/bin/pip install --upgrade pip
  - /app/venv/bin/pip install -r /app/requirements_backend.txt

  # Start app (via SystemD)
  - systemctl daemon-reload
  - systemctl enable flaskapp
  - sleep 5
  - systemctl start flaskapp
