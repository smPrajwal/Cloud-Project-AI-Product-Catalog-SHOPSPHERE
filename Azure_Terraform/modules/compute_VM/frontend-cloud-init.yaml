#cloud-config

write_files:
  - path: /etc/environment
    append: true
    content: |
      FLASK_SECRET=${flask_secret}
      AZURE_SQL_CONN=${azure_sql_conn}
      ADMIN_USERNAME=${admin_username}
      ADMIN_PASSWORD=${admin_password}
      CLOUD_ENV=true

package_update: true
packages:
  - python3-pip
  - python3-venv
  - python3-dev
  - unixodbc-dev
  - gnupg2
  - curl
  - unzip

runcmd:
  # ODBC Driver 18
  - curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
  - curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list > /etc/apt/sources.list.d/mssql-release.list
  - apt-get update
  - ACCEPT_EULA=Y apt-get install -y msodbcsql18

  # App setup
  - mkdir -p /app
  - chown -R ${vm_user}:${vm_user} /app
  - cd /app

  # Wait for frontend ZIP and download
  - |
    echo "Waiting for frontend ZIP to be available..."
    until curl -sf "${frontend_blob_url}" -o /tmp/frontend.zip; do
      echo "Frontend ZIP not available yet, retrying in 10 seconds..."
      sleep 10
    done

  - unzip /tmp/frontend.zip
  - rm /tmp/frontend.zip

  # Python setup
  - python3 -m venv venv
  - . venv/bin/activate
  - pip install --upgrade pip
  - pip install -r requirements_frontend.txt

  # Start app
  - chmod +x startup.sh
  - ./startup.sh
